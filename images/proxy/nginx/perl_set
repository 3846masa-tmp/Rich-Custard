perl_set $proxy '

use strict;
use warnings;
use WWW::Curl::Easy;
use JSON "decode_json";

sub {
  my $r = shift;

  my $host = $r->header_in("Host");
  $host =~ s/\Q$ENV{"DOMAIN"}\E//;
  my ($container, $port) = split(/\./, $host);
  $port = "80" unless ($port =~ /^\d+$/);

  my $json = "";
  my $curl = WWW::Curl::Easy->new;
  $curl->setopt(CURLOPT_URL, "http://localhost/containers/${container}/json");
  $curl->setopt(CURLOPT_WRITEDATA, \$json);
  $curl->setopt(CURLOPT_TIMEOUT, 1);
  $curl->perform;

  return "" if ($curl->getinfo(CURLINFO_HTTP_CODE) != 200);

  my $data = decode_json($json);
  return "" if ($$data{"Config"}{"Hostname"} eq $ENV{"HOSTNAME"});

  return $$data{"NetworkSettings"}{"IPAddress"} . ":" . $port;
}

';
